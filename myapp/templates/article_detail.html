{% extends "base.html" %}
{% load static %}

{% block extra_head %}
<style>
/*============================
  GENERAL ARTICLE STYLING
============================*/
.article-container {
    max-width: 1080px;
    margin: 2rem auto;
    padding: 2rem;
    background: var(--article-bg, rgba(255, 255, 255, 0.95));
    border-radius: 10px;
    box-shadow: 0 5px 30px rgba(0, 0, 0, 0.1);
}

body.dark-mode .article-container {
    background: var(--article-dark-bg, rgba(26, 61, 81, 0.95));
}

.article-container h1 {
    font-family: 'DM Serif Text', serif;
    color: var(--bs-primary);
    margin-bottom: 1.5rem;
    line-height: 1.3;
    text-align: center;
}

body.dark-mode .article-container h1 {
    color: var(--bs-secondary);
}

/*============================
  META INFO
============================*/
.article-meta {
    text-align: center;
    margin-bottom: 2rem;
    color: var(--article-meta, #6c757d);
    font-size: 0.95rem;
}

body.dark-mode .article-meta {
    color: var(--article-meta-dark, #d7b085);
}

.article-meta a {
    color: #0077b5; /* LinkedIn blue */
    font-weight: 500;
}

.article-meta a:hover {
    text-decoration: underline;
}

/*============================
  HORIZONTAL LINE
============================*/
.article-container hr {
    border-color: var(--article-hr, rgba(215, 176, 133, 0.3));
    margin: 2rem 0;
}

/*============================
  MAIN ARTICLE BODY
============================*/
.article-body {
    font-family: 'Montserrat', sans-serif;
    line-height: 1.8;
    color: var(--article-text, #333);
    font-size: 1.1rem;
}

body.dark-mode .article-body {
    color: var(--article-text-dark, #f0f0f0);
}

.article-body p {
    margin-bottom: 1.5rem;
}

.article-body a {
    color: var(--bs-primary);
    text-decoration: none;
    border-bottom: 1px dotted var(--bs-primary);
    transition: all 0.3s ease;
}

body.dark-mode .article-body a {
    color: var(--bs-secondary);
    border-bottom-color: var(--bs-secondary);
}

.article-body a:hover {
    color: var(--bs-secondary);
    border-bottom: 1px solid var(--bs-secondary);
}

body.dark-mode .article-body a:hover {
    color: var(--bs-primary);
    border-bottom-color: var(--bs-primary);
}

/*============================
  HEADINGS INSIDE ARTICLE
============================*/
.article-body h2,
.article-body h3,
.article-body h4 {
    margin-top: 2rem;
    margin-bottom: 1rem;
    color: var(--bs-primary);
}

body.dark-mode .article-body h2,
body.dark-mode .article-body h3,
body.dark-mode .article-body h4 {
    color: var(--bs-secondary);
}

/*============================
  INLINE IMAGES
============================*/
.article-body img {
    max-width: 100%;
    height: auto;
    display: block;
    margin: 1.5rem auto;
    border-radius: 8px;
}

.comment-form {
    background: var(--comment-form-bg, #f8f9fa);
    padding: 2rem;
    border-radius: 8px;
    margin-top: 2rem;
}

body.dark-mode .comment-form {
    background: var(--comment-form-dark-bg, #2c3e50);
}

.comment-form label {
    color: var(--comment-label, #495057);
    font-weight: 500;
}

body.dark-mode .comment-form label {
    color: var(--comment-label-dark, #d7b085);
}

.comment-form .form-control {
    background: var(--comment-input-bg, #fff);
    border-color: var(--comment-input-border, #ced4da);
    color: var(--comment-input-text, #495057);
}

body.dark-mode .comment-form .form-control {
    background: var(--comment-input-dark-bg, #34495e);
    border-color: var(--comment-input-dark-border, #4a6278);
    color: var(--comment-input-dark-text, #f0f0f0);
}

/*============================
  PDF VIEWER + DOWNLOAD
============================*/
.pdf-viewer-container {
    margin: 2rem 0;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
}

.pdf-download {
    display: inline-block;
    margin-top: 1rem;
    padding: 0.5rem 1rem;
    background-color: var(--bs-primary);
    color: white;
    border-radius: 50px;
    transition: all 0.3s ease;
}

.pdf-download:hover {
    background-color: var(--bs-secondary);
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
}

body.dark-mode .pdf-download {
    background-color: var(--bs-secondary);
}

body.dark-mode .pdf-download:hover {
    background-color: var(--bs-primary);
}

/*============================
  FLOATING TABLE OF CONTENTS
============================*/
.floating-toc {
    position: fixed;
    top: 100px;
    right: 20px;
    width: 220px;
    background: #f8f9fa;
    padding: 10px 15px;
    border-radius: 8px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    z-index: 999;
    max-height: 80vh;
    overflow-y: auto;
    font-size: 14px;
    direction: rtl;
}

.floating-toc h5 {
    margin-top: 0;
    font-weight: bold;
}

.floating-toc ul {
    list-style: none;
    padding: 0;
    margin: 0;
}

.floating-toc li {
    margin-bottom: 5px;
}

.floating-toc a {
    text-decoration: none;
    color: #333;
}

.floating-toc a:hover {
    color: #007bff;
}

.toc-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
}

#toc-toggle {
    background: none;
    border: none;
    font-size: 1rem;
    cursor: pointer;
    padding: 0;
    color: #555;
}

#toc-toggle:hover {
    color: #007bff;
}

/*============================
  RESPONSIVE ADJUSTMENTS
============================*/
@media (max-width: 768px) {
    .article-container {
        padding: 1.5rem;
        margin: 1rem;
    }

    .article-container h1 {
        font-size: 1.8rem;
    }

    .article-body {
        font-size: 1rem;
    }

    .floating-toc {
        display: none;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="article-container wow fadeIn" data-wow-delay=".3s">

    <!-- Title -->
    <h1>{{ article.title }}</h1>

    <!-- Metadata -->
    <div class="article-meta">
        By <strong>{{ article.author }}</strong> • {{ article.date_published }}
        
        {% if article.linkedin_url %}
            <br>
            🔗 <a href="{{ article.linkedin_url }}" target="_blank">View Author on LinkedIn</a>
        {% endif %}

        {% if article.external_url %}
            <br>
            📄 <a href="{{ article.external_url }}" target="_blank">Read Full Article on External Site</a>
        {% endif %}
    </div>
    <hr>

  <!-- FEATURED IMAGE -->
  {% if article.image %}
  <div class="article-image text-center mb-4">
      <img src="{{ article.image }}" alt="Featured Image" class="img-fluid rounded" style="max-height: 500px;">
  </div>
  {% endif %}

    <div class="floating-toc" id="floating-toc">
        <div class="toc-header">
            <h5>📑 المحتويات</h5>
            <button id="toc-toggle" title="إخفاء / إظهار الفهرس">📂</button>
        </div>
        <ul id="toc-list"></ul>
    </div>

    <!-- PDF VIEWER (FALLBACK) -->
    {% if article.pdf_file %}
    <div class="pdf-viewer-container">
        <iframe src="{{ article.pdf_file.url }}" width="100%" height="800px" style="border:none;"></iframe>
    </div>
    <a href="{{ article.pdf_file.url }}" target="_blank" class="pdf-download">
        <i class="fas fa-download me-2"></i>Download PDF
    </a>

    <!-- INLINE MARKDOWN/HTML CONTENT WITH IMAGES -->
    {% else %}
    <div lang="ar" dir="rtl" class="article-body">
        {{ rendered_content|safe }}
    </div>
    {% endif %}
</div>

    <hr>
    <div class="container mt-5">
      <h3 class="mb-4">Comments ({{ comments|length }})</h3>

      <!-- SUCCESS/ERROR MESSAGES -->
      <div class="comment-alerts">
        {% if comment_success %}
        <div class="alert alert-success alert-dismissible fade show mb-4">
          ✔ Comment posted successfully!
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endif %}
        
        {% if comment_error %}
        <div class="alert alert-danger alert-dismissible fade show mb-4">
          ⚠ {{ comment_error }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endif %}
      </div>
    
      <!-- Comment List -->
      {% if comments %}
        <div class="mb-4">
          {% for comment in comments %}
            <div class="mb-3 p-3 border rounded shadow-sm bg-light">
              <strong>{{ comment.name }}</strong>
              <small class="text-muted d-block">{{ comment.created_at|date:"F j, Y, g:i a" }}</small>
              <p class="mt-2 mb-0">{{ comment.content }}</p>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <p class="text-muted">No comments yet. Be the first to share your thoughts!</p>
      {% endif %}
    
      <!-- Comment Form -->
      <div class="mt-5 comment-form">
          <h4>Leave a Comment</h4>
          <form method="post">
              {% csrf_token %}
              <div class="mb-3">
                  <label for="name" class="form-label">Your Name</label>
                  <input type="text" class="form-control" id="name" name="name" required maxlength="100" 
                         value="{{ request.POST.name|default:'' }}">
              </div>
              <div class="mb-3">
                  <label for="content" class="form-label">Your Comment</label>
                  <textarea class="form-control" id="content" name="content" rows="4" required>{{ request.POST.content|default:'' }}</textarea>
              </div>
              <button type="submit" class="btn btn-primary">Submit Comment</button>
          </form>
      </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", function () {
    const tocList = document.getElementById("toc-list");
    const articleBody = document.querySelector(".article-body");
    const tocToggle = document.getElementById("toc-toggle");

    if (!tocList || !articleBody) return;

    const headings = articleBody.querySelectorAll("h2, h3");
    headings.forEach((heading, idx) => {
        const text = heading.innerText;
        const slug = "toc-" + idx;
        heading.id = slug;

        const li = document.createElement("li");
        const a = document.createElement("a");
        a.href = "#" + slug;
        a.innerText = text;

        li.appendChild(a);
        tocList.appendChild(li);
    });

    // Collapse/expand logic
    if (tocToggle) {
        tocToggle.addEventListener("click", function () {
            tocList.classList.toggle("hidden");
            tocToggle.innerText = tocList.classList.contains("hidden") ? "📁" : "📂";
        });
    }

    document.querySelector('form').addEventListener('submit', function(e) {
        const submitBtn = this.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Posting...';
    });
  
});
</script>

<style>
.hidden {
    display: none;
}
</style>
{% endblock %}
