{% load static %}

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>{% block title %}Ezz Eldin Ahmed{% endblock %}</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <meta content="" name="keywords">
    <meta content="" name="description">

    <!-- Google Web Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Text:ital@0;1&family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">

    <!-- Icon Font Stylesheet -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha512-..." crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" integrity="sha384-..." crossorigin="anonymous" />

    <!-- Libraries Stylesheet -->
    <link href="{% static 'lib/animate/animate.min.css' %}" rel="stylesheet">
    <link href="{% static 'lib/owlcarousel/assets/owl.carousel.min.css' %}" rel="stylesheet">

    <!-- Customized Bootstrap Stylesheet -->
    <link href="{% static 'css/bootstrap.min.css' %}" rel="stylesheet">

    <!-- Template Stylesheet -->
    <link href="{% static 'css/main.css' %}" rel="stylesheet">

    <!-- Favicon -->
    <link rel="icon" href="{% static 'img/favicon.ico' %}" type="image/x-icon">

    <!-- Vercel Analytics -->
    <script defer src="/_vercel/insights/script.js"></script>

    <!-- Vercel Speed Insights -->
    <script defer src="/_vercel/speed-insights/script.js"></script>

    {% block extra_head %}{% endblock %}
    {% block extra_js %}{% endblock %}
</head>

<body>
    <!-- Navbar Start -->
    <div class="container-fluid bg-primary sticky-top">
        <div class="container-fluid bg-primary">
            <div class="container">
                <nav class="navbar navbar-dark navbar-expand-lg py-0">
                    <a href="{% url 'home' %}" class="navbar-brand">
                        <h1 class="text-white fw-bold d-block">EzzEldin<span class="text-secondary">Ahmed</span></h1>
                    </a>
                    <button type="button" class="navbar-toggler me-0" data-bs-toggle="collapse" data-bs-target="#navbarCollapse">
                        <span class="navbar-toggler-icon"></span>
                    </button>
                    <div class="collapse navbar-collapse bg-transparent" id="navbarCollapse">
                        <div class="navbar-nav ms-auto mx-xl-auto p-0">
                            <a href="{% url 'about' %}" class="nav-item nav-link {% if request.resolver_match.url_name == 'about' %}active{% endif %}">About Ezz (me!)</a>
                            <a href="{% url 'projects' %}" class="nav-item nav-link {% if request.resolver_match.url_name == 'projects' %}active{% endif %}">Projects</a>
                            <a href="{% url 'mstag' %}" class="nav-item nav-link {% if request.resolver_match.url_name == 'mstag' %}active{% endif %}">MSTAG</a>
                        </div>
                        <div class="d-flex hightech-link mt-1 justify-content-between">
                            <a href="https://www.linkedin.com/in/ezzeldinahmed11/" class="btn-light nav-fill btn btn-square rounded-circle me-2">
                                <i class="fab fa-linkedin-in text-primary"></i>
                            </a>
                            <a href="https://github.com/Ezzio11" class="btn-light nav-fill btn btn-square rounded-circle me-2">
                                <i class="fab fa-github"></i>
                            </a>
                            <!-- Dark Mode Switcher Button -->
                            <button id="dark-mode-toggle" class="btn btn-outline-light ms-2">
                                <i id="dark-mode-icon" class="fas fa-moon"></i>
                            </button>
                        </div>
                    </div>
                </nav>
            </div>
        </div>
    </div>
    <!-- Navbar End -->

    {% block content %}{% endblock %}

    <!-- Footer Start -->
    <div class="container-fluid footer bg-primary">
        <div class="container pt-5 pb-4">
            <div class="row g-5">
                <!-- Logo + Name -->
                <div class="col-lg-3 col-md-6">
                    <a href="{% url 'home' %}">
                        <div class="h-0 position-relative">
                            <img src="{% static 'img/logo.png' %}" class="img-fluid w-75 rounded" alt="" style="margin-bottom: 25%;">
                        </div>
                        <h1 class="text-white fw-bold d-block">EzzEldin<span class="text-secondary">Ahmed</span></h1>
                    </a>
                </div>

                <!-- Contact Me + Icons -->
                <div class="col-lg-3 col-md-6 ms-auto">
                    <a href="#" class="h3 text-secondary">Contact Me</a>
                    <div class="text-white mt-4 d-flex flex-column contact-link">
                        <a href="https://api.whatsapp.com/send?phone=+2001226566818" class="py-3 text-light border-bottom border-white">
                            <i class="fas fa-message text-secondary me-2"></i>WhatsApp
                        </a>
                        <a href="tel:+2001226566818" class="py-3 text-light border-bottom border-white">
                            <i class="fas fa-phone-alt text-secondary me-2"></i>01226566818
                        </a>
                        <a href="mailto:ezzeldinahmad96@gmail.com" class="py-3 text-light border-bottom border-white">
                            <i class="fas fa-envelope text-secondary me-2"></i>ezzeldinahmad96@gmail.com
                        </a>
                    </div>

                    <!-- Social Icons -->
                    <div class="d-flex hightech-link mt-3 justify-content-start">
                        <a href="https://www.linkedin.com/in/ezzeldinahmed11/" class="btn-light nav-fill btn btn-square rounded-circle me-2">
                            <i class="fab fa-linkedin-in text-primary"></i>
                        </a>
                        <a href="https://github.com/Ezzio11" class="btn-light nav-fill btn btn-square rounded-circle me-2">
                            <i class="fab fa-github"></i>
                        </a>
                    </div>
                </div>
            </div>

            <hr class="text-light mt-5 mb-4">

            <div class="row">
                <div class="col-md-6 text-center text-md-start">
                    <span class="text-light">
                        <a href="#" class="text-secondary">
                            <i class="fas fa-copyright text-secondary me-2"></i>
                            Ezz Eldin Ahmed
                        </a>, All right reserved.
                    </span>
                </div>
                <div class="col-md-6 text-center text-md-end">
                    <span class="text-light">
                        Designed By
                        <a href="https://htmlcodex.com" class="text-secondary">HTML Codex</a>
                        Distributed By
                        <a href="https://themewagon.com">ThemeWagon</a>
                    </span>
                </div>
            </div>
        </div>
    </div>
    <!-- Footer End -->

    <!-- Back to Top -->
    {% if request.resolver_match.url_name == 'article_detail' %}
    <a href="#" class="btn btn-secondary btn-square rounded-circle back-to-top">
        <i class="fa fa-arrow-up text-white"></i>
    </a>
    {% endif %}
    
    <!-- Chat Bubble -->
    <div id="chat-bubble" class="btn btn-secondary btn-square rounded-circle" title="Chat with us" aria-label="Open chat panel" role="button" tabindex="0">
        <i class="fa-solid fa-robot text-white" style="font-size: 1.8rem;"></i>
    </div>
    
    <!-- Chat Panel -->
    <div id="chat-panel" aria-live="polite" role="region" aria-label="Chat panel" tabindex="-1">
        <div id="chat-messages" style="flex: 1; overflow-y: auto; padding: 10px; font-size: 0.9rem; min-height: 400px;"></div>
        <form id="chat-form" style="display: flex; padding: 10px; border-top: 1px solid #ddd;" aria-label="Send message form">
            <input id="chat-input" type="text" placeholder="Ask me..." style="flex: 1; padding: 8px; border-radius: 5px; border: 1px solid #ccc;" autocomplete="off" aria-required="true" />
            <button type="submit" style="margin-left: 10px; padding: 8px 12px; border-radius: 5px; border: none; background-color: #6c757d; color: white;" aria-label="Send message">Send</button>
        </form>
    </div>
    
    <!-- JavaScript Libraries -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{% static 'lib/easing/easing.min.js' %}"></script>
    <script src="{% static 'lib/waypoints/waypoints.min.js' %}"></script>
    <script src="{% static 'lib/owlcarousel/owl.carousel.min.js' %}"></script>
    
    <!-- Template Javascript -->
    <script src="{% static 'js/main.js' %}"></script>
    
    {% block extra_scripts %}
    <script>
        const bubble = document.getElementById('chat-bubble');
        const panel = document.getElementById('chat-panel');
        const chatMessages = document.getElementById('chat-messages');
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
    
        // Improved focus helper to prevent scrolling
        function focusWithoutScroll(el) {
            if (!el || !el.focus) return;
            
            // Store current scroll position
            const scrollX = window.scrollX;
            const scrollY = window.scrollY;
            
            // Focus the element
            el.focus();
            
            // Immediately restore scroll position
            window.scrollTo(scrollX, scrollY);
        }
    
        // Load bubble position from localStorage or default
        function loadBubblePosition() {
            const left = localStorage.getItem('chatBubbleLeft');
            const top = localStorage.getItem('chatBubbleTop');
            if (left && top) {
                bubble.style.left = left;
                bubble.style.top = top;
                bubble.style.bottom = 'auto';
                bubble.style.right = 'auto';
            } else {
                bubble.style.bottom = '20px';
                bubble.style.right = '20px';
            }
        }
    
        loadBubblePosition();
    
        // Toggle chat panel with fade animation
        function showPanel() {
            panel.style.display = 'flex';
            panel.style.opacity = 0;
            let opacity = 0;
            const fadeIn = setInterval(() => {
                if (opacity >= 1) {
                    clearInterval(fadeIn);
                    focusWithoutScroll(chatInput);
                } else {
                    opacity += 0.1;
                    panel.style.opacity = opacity;
                }
            }, 20);
        }
    
        function hidePanel() {
            let opacity = 1;
            const fadeOut = setInterval(() => {
                if (opacity <= 0) {
                    clearInterval(fadeOut);
                    panel.style.display = 'none';
                } else {
                    opacity -= 0.1;
                    panel.style.opacity = opacity;
                }
            }, 20);
        }
    
        bubble.addEventListener('click', (e) => {
            if (bubble.dataset.dragging === 'true') return;
            e.preventDefault();
            if (panel.style.display === 'flex') {
                hidePanel();
            } else {
                showPanel();
            }
        });
    
        // Dragging logic with position persistence
        let isDragging = false, offsetX = 0, offsetY = 0;
    
        bubble.addEventListener('mousedown', (e) => {
            isDragging = true;
            bubble.dataset.dragging = 'false';
            offsetX = e.clientX - bubble.offsetLeft;
            offsetY = e.clientY - bubble.offsetTop;
            document.addEventListener('mousemove', moveBubble);
            document.addEventListener('mouseup', stopDrag);
        });
    
        function moveBubble(e) {
            if (!isDragging) return;
            bubble.dataset.dragging = 'true';
            let newLeft = (e.clientX - offsetX);
            let newTop = (e.clientY - offsetY);
    
            const maxLeft = window.innerWidth - bubble.offsetWidth;
            const maxTop = window.innerHeight - bubble.offsetHeight;
            newLeft = Math.min(Math.max(0, newLeft), maxLeft);
            newTop = Math.min(Math.max(0, newTop), maxTop);
    
            bubble.style.left = newLeft + 'px';
            bubble.style.top = newTop + 'px';
            bubble.style.bottom = 'auto';
            bubble.style.right = 'auto';
        }
    
        function stopDrag() {
            isDragging = false;
            document.removeEventListener('mousemove', moveBubble);
            document.removeEventListener('mouseup', stopDrag);
            setTimeout(() => { bubble.dataset.dragging = 'false'; }, 100);
    
            localStorage.setItem('chatBubbleLeft', bubble.style.left);
            localStorage.setItem('chatBubbleTop', bubble.style.top);
        }
    
        // Chat form submission logic
        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const message = chatInput.value.trim();
            if (!message) return;
        
            // Clear previous errors
            document.querySelectorAll('.error-message').forEach(el => el.remove());
            
            // Display user message
            appendMessage('You', message);
            chatInput.value = '';
            chatInput.disabled = true;
        
            // Create bot message container
            const botMessageDiv = document.createElement('div');
            botMessageDiv.style.marginBottom = '10px';
            botMessageDiv.innerHTML = '<strong>Bot:</strong> ';
            chatMessages.appendChild(botMessageDiv);
            const botMessageContent = document.createTextNode('');
            botMessageDiv.appendChild(botMessageContent);
        
            try {
                const response = await fetch('/chatbot/api/', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken'),
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({ question: message }),
                });
        
                // Check for HTML response
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('text/html')) {
                    throw new Error("Server configuration issue detected");
                }
        
                if (!response.ok) {
                    const error = await response.json().catch(() => ({}));
                    throw new Error(error.error || "Request failed");
                }
        
                // Process stream
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                
                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;
                    
                    const chunk = decoder.decode(value);
                    botMessageContent.nodeValue += chunk;
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }
        
            } catch (error) {
                console.error('Chat error:', error);
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error-message';
                errorDiv.style.color = '#dc3545';
                errorDiv.textContent = `Error: ${error.message || 'Failed to get response'}`;
                chatMessages.appendChild(errorDiv);
            } finally {
                chatInput.disabled = false;
                setTimeout(() => focusWithoutScroll(chatInput), 100);
            }
        });
    
        function appendMessage(sender, text) {
            const div = document.createElement('div');
            div.style.marginBottom = '10px';
            div.innerHTML = `<strong>${sender}:</strong> ${escapeHtml(text)}`;
            chatMessages.appendChild(div);
            
            // Scroll to bottom without affecting page scroll
            const scrollPosition = window.scrollY;
            chatMessages.scrollTop = chatMessages.scrollHeight;
            window.scrollTo(0, scrollPosition);
        }
    
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let cookie of cookies) {
                    cookie = cookie.trim();
                    if (cookie.startsWith(name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    
        // Additional prevention for form submission causing scroll
        document.addEventListener('scroll', function() {
            if (document.activeElement === chatInput) {
                window.scrollTo(0, 0);
            }
        }, { passive: false });
    </script>
    {% endblock %}

    <style>
        /* Chat bubble button */
        #chat-bubble {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 9999; /* make sure it’s above most elements */
            cursor: grab;
            display: flex;
            justify-content: center;
            align-items: center;
            user-select: none;
            width: 60px;
            height: 60px;
            font-size: 1.8rem;
            border-radius: 50%;
            background-color: #6c757d; /* match btn-secondary */
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            transition: background-color 0.3s ease;
        }
        #chat-bubble:hover {
            background-color: #5a6268;
        }
        #chat-bubble:active {
            cursor: grabbing;
        }
    
        /* Chat panel popup */
        #chat-panel {
            position: fixed;
            bottom: 90px;
            right: 20px;
            width: 350px;
            height: 500px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            display: none;
            flex-direction: column;
            overflow: hidden;
            z-index: 10000; /* above bubble */
            font-family: Arial, sans-serif;
            opacity: 1;
        }
    
        #chat-panel #chat-messages {
            padding: 10px;
            overflow-y: auto;
            flex-grow: 1;
            scrollbar-width: thin;
            scrollbar-color: #888 #eee;
        }
    
        /* Optional nice scrollbar for WebKit */
        #chat-panel #chat-messages::-webkit-scrollbar {
            width: 8px;
        }
        #chat-panel #chat-messages::-webkit-scrollbar-track {
            background: #eee;
        }
        #chat-panel #chat-messages::-webkit-scrollbar-thumb {
            background-color: #888;
            border-radius: 4px;
        }
    
        #chat-panel form {
            display: flex;
            padding: 10px;
            border-top: 1px solid #ddd;
        }
    
        #chat-panel input[type="text"] {
            flex-grow: 1;
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #ccc;
        }
    
        #chat-panel button {
            margin-left: 10px;
            padding: 8px 12px;
            border-radius: 5px;
            border: none;
            background-color: #6c757d;
            color: white;
            cursor: pointer;
        }
    
        #chat-panel button:hover {
            background-color: #5a6268;
        }
    </style>

</body>
</html>
